{
  "name": "Safe Runner",
  "image": "mcr.microsoft.com/devcontainers/base:ubuntu-22.04",

  "features": {
    "ghcr.io/devcontainers/features/node:1": { "version": "lts" },
    "ghcr.io/devcontainers/features/python:1": { "version": "latest" },
    "ghcr.io/devcontainers/features/php:1": { "version": "latest", "installComposer": true },
    "ghcr.io/devcontainers/features/github-cli:1": { "version": "latest" },
    "ghcr.io/devcontainers/features/go:1": { "version": "latest" }
  },

  "customizations": {
    "codespaces": {
      "repositories": {
        "permissions": { "codespaces": "write" }
      }
    }
  },

  "runArgs": [
    "--cap-drop=SYS_ADMIN",
    "--cap-drop=NET_ADMIN",
    "--cap-drop=SYS_PTRACE",
    "--security-opt=no-new-privileges",
    "--pids-limit=256",
    "--init"
  ],

  "containerEnv": {
    "SAFE_RUN_ENV": "true"
  },

  //INSTALL TOOLS (Prebuild)
  "updateContentCommand": "pip install --user semgrep && go install github.com/google/osv-scanner/cmd/osv-scanner@v1",

  // CONFIGURE SHELL (Runs once at creation)
  // We add the alias here so it is ready BEFORE you log in.
  "postCreateCommand": "chmod +x audit.sh run.sh rules/*.sh && echo 'alias nuke=\"gh codespace delete --codespace $CODESPACE_NAME --force\"' >> /home/vscode/.bashrc",

  //  RUNTIME SAFETY
  //  (Runs every time the container starts)
  //  Only the timer runs here.
  "postStartCommand": "nohup bash -c 'sleep 7200 && gh codespace delete --codespace $CODESPACE_NAME --force' > /dev/null 2>&1 & echo 'âœ… Safe Runner Active. Type `nuke` to destroy codespace.'"
}